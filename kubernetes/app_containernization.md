## 应用容器化实践

> 即便有了kubernetes，想用好它也不是一件容易的事，使用kubernetes的第一件事就是需要对应用进行容器化，目的就是让应用可以在任何一台宿主机上运行。

> 从系统架构角度上来说，一般会分成3个部分：接入层、逻辑层、存储层。接入层一般是apiserver，逻辑层是执行具体的业务逻辑，存储层一般就是数据库。接入层和逻辑层是无状态的，一般只要处理配置文件就行，当然，有时候还可能会需要处理本地缓存的文件。而存储层是有状态的，就需要使用StatefulSet或者直接在宿主机上部署。

### 1 配置文件

kubernetes中提供了configmap和secrets分别处理常规配置文件和加密配置文件。可以对配置文件创建configmap，然后通过volume的形式挂载到容器。这种方式将二进制和配置文件分离，可以分别进行管理，但是，如果需要热加载配置文件，程序就需要定期检查配置文件是否变更，如果变更就更新内存中的配置，这时候很多对象都需要进行更新。如果想要简单处理的话，可以直接将配置文件打包进镜像，版本跟程序走。不过，最简单的方式是不需要配置，或者可以从某个地方拉取到配置，这样更方便部署。

### 2 挂载目录

在有些业务场景下，容器会需要使用宿主机上的程序或者文件，此时，可以将宿主机上的目录挂载到容器中，这就需要用到hostPath volume。

pod的volume一般可以分为几大类：

* emptyDir：空的目录，一般用于pod中多个容器的目录共享
* hostPath：使用宿主机上的目录
* configMap & secret：配置文件
* persistentVolumeClaim：PVC
* downwardAPI：暴露pod的一些参数
* gitRepo：git仓库
* 其他网络存储卷：NFS、AWS卷等

一般就只会使用configMap、secret、PVC，其他类型的卷较少使用。

### 3 存储

存储层(数据库)一般是最后才考虑容器化的，通常使用Stateful或者operator部署。

### 4 日志

日志对于分析问题、解决问题有重要意义，因此，对于程序来说有必要采集日志。对于容器来说，日志可以输出到标准输出，也可以输出到文件，由于标准输出的日志不够灵活(无法分类、只能打印主容器的日志等)，还是建议打印到文件，然后挂载到宿主机目录，由采集程序进行采集。

### 5 hostIPC、hostNetwork、hostPID

在某些特殊场景下，Pod需要使用宿主机的环境，k8s提供了三个namespace的使用：

* hostIPC：使用宿主机的IPC namespace，那么就可以与宿主机上面的进行通信
* hostNetwork：使用宿主机的network namespac，那么就不会给pod分配IP，而直接使用宿主机的IP
* hostPID：使用宿主机的PID namespace，那么在宿主机中看到的进程(ps)跟容器中看到的一样，未进行PID的隔离