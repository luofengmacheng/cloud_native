## 如何实现一个agent

### 1 什么是agent?

首先问下kimi：

```
我：什么是agent技术
kimi：Agent技术是指在客户端机器上部署一个Agent进程，该进程作为客户端与服务端之间的中介，负责处理客户端的请求并与之进行通信。Agent通常与客户端位于同一主机上，可以通过本地通信方式（如localhost）进行访问。Agent技术能够解决工程效率问题和架构演进的问题，它通过在客户端部署Agent进程，实现了服务端的部分计算和逻辑处理，从而减轻了服务端的压力，并降低了服务端代码的复杂度。此外，Agent技术还有助于基础组件与业务的解耦，使得基础架构的变更不再依赖于业务方的升级和发布，提高了系统的灵活性和可维护性2。
```

简而言之，一种功能的实现不可能完全由服务端完成，特别是对于分布式系统而言，需要在机器上部署一个程序，该程序会接收服务端的消息，然后执行一定的业务逻辑。

举两个例子：

例1：当电脑上安装一些安全软件时，该软件就相当于是agent，该软件启动后会从服务端（也就是安全软件的后台管理端）下载病毒库进行更新，当执行本地文件扫描时，可以先使用一些本地扫描的技术，还可能将本地文件上传到边缘或者云端进行查杀。

例2：在k8s集群中，每个机器上会安装kubelet和containerd（或者是其他运行时），这里的kubelet就相当于是agent，kubelet启动后会连接apiserver，监听pod调度的变更，然后调用containerd管理容器。

总之，agent通常与服务端（或者称为管理端）一起构成分布式系统，agent会接收服务端发来的任务，利用本地算力进行处理，上报任务结果，实现典型的`客户端-服务端模式`。

### 2 实现agent需要考虑的问题

#### 2.1 agent与服务端的交互方式

agent作为客户端程序，可以独立运行，但是，有时候还是需要与服务端交互，典型的场景如上面所说的将本地文件上传到云端进行查杀等。

agent与服务端的交互方式通常采用任务的形式，也就是服务端下发一个任务给agent，agent在收到任务后，解析出执行的操作和参数，然后执行对应的业务逻辑，在执行业务逻辑的过程中可能还会调用服务端的接口，最后再将执行结果上报给服务端。

因此，agent在启动后会先与服务端建立连接，进行安全认证后建立一个数据交互的通道，后续服务端就通过该通道下发任务。

服务端向agent下发任务时有两种方式：

* 直接将任务的所有数据都放到任务中
* 任务中只是一个消息，执行该任务需要的数据都是在agent执行任务过程中调用服务端的接口拉取

第一种方式看似简单，却存在很多问题，所有数据都放到任务里面，如果所有的，

#### 2.2 agent的扩展性



#### 2.3 agent的异常自监控

