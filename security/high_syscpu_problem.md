## 系统CPU高的问题定位

### 1 问题背景

在CentOS 6.5上测试某个程序功能发现系统CPU高，影响其他程序的正常运行，需要确认系统CPU高导致的影响以及系统CPU高的原因。

### 2 系统CPU

CPU时间是指CPU在不同状态下的运行时间：

* 系统CPU时间：CPU花在内核进程上的时间
* 用户CPU时间：CPU花在用户进程上的时间
* 空闲CPU时间：CPU空闲的时间

如果系统CPU时间占比高，表示大量时间都在执行内核代码，没有时间执行用户代码，导致系统响应变慢，甚至出现卡顿的情况。

Linux上如何查看这些CPU时间呢？

`top`命令可以查看每个CPU上面时间分配的占比：

* us：user，用户CPU时间
* sy：system，系统CPU时间
* ni：nide，优先级较高的进程占用的CPU时间
* id：idle，空闲CPU时间
* wa：wait，等待IO的时间
* hi：硬件中断占用的CPU时间
* si：软件中断占用的CPU时间
* st：steal time，虚拟化环境中运行虚拟机的CPU时间

上述这些CPU时间相加就是100%

`mpstat`命令输出的数据除了包含上面的8个字段，还有guest字段：虚拟机占用的CPU。另外，与top不同的是，mpstat还可以定时输出，因此，可以用于数据的周期性采集上报。`mpstat 1 10`：每隔1秒查看一次数据，总共查看10次。

top和mpstat都可以查看整个系统的CPU时间的占比，`pidstat`可以查看某个进程的CPU时间的占比，`pidstat -p 1234 1 10`可以查看1234这个进程的CPU时间的占比。

### 2 确定问题方向

由于我们的程序使用了audit的机制，单独找个机器部署`CentOS 5.6(内核版本为2.6.32-696.6.3.el6.x86_64)`，不安装我们的程序，直接使用auditd接收审计日志，然后用1000eps(Events Per Second)的写事件进行测试，发现系统CPU明显升高，当事件量级达到4000eps时，系统CPU达到50%，说明audit自身的实现存在一些问题。

audit由用户态的程序auditd和内核代码以及内核线程kauditd组成：

* auditd负责接收审计日志并写入到日志文件
* 内核代码负责生成审计日志
* kauditd负责将内核队列中的审计日志发送到用户态

清楚了问题，可以先使用pidstat对auditd和kauditd进行分析。

### 3

