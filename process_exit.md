### 如何定位进程异常退出的问题？

#### 0 前言

线上的服务，通常最关心的是2个部分：

* 进程：存活且可以正常提供服务(执行业务逻辑)
* 日志：正常打印日志并将日志上报到日志服务器，用于后续日志分析

对于进程而言，最容易监控的方式就是进程存活：通过`ps -ef`判断进程是否存在。但是，无论是运维人员自己写crontab还是通过企业内部的部署平台自动拉起进程，在出现进程不存活时都是需要定位和查看的。

那么，如果出现进程不存活/突然挂掉时应该如何查看并定位呢？

此时，需要看3个地方：

* 进程日志
* 系统日志
* 系统指标

#### 1 进程日志

进程突然挂掉，第一步可以查看进程相关的日志：查看进程日志中是否有报错，例如panic或者exception等信息，通过堆栈可以知道出现问题的代码。

#### 2 系统日志和系统指标

如果进程的日志没有异常，可以查看系统日志和系统的指标。

系统日志通过dmesg命令或者日志文件查看：

* dmesg：可以查看内核相关的日志，如果是物理机，在/var/log下面会有dmesg文件，如果是容器，可以通过dmesg查看。dmesg有3个比较常用的选项：-L，用颜色区分日志；-T，将时间转换为可读的时间；
* /var/log/xxx：常见需要查看的是kern(内核日志)、messages(所有系统日志)

通过查看系统日志可以知道进程在什么时间被Killed，大部分都是由于OOM被Killed的。此时就应该通过查看代码或者利用检测工具查看代码是否有内存泄漏。

查看完系统日志，也可以查看下系统指标看进程挂掉的时间点是否有啥异常，例如，内存使用率持续升高、连接数增多。

#### 3 其他

上面根据查看进程日志、系统日志、系统指标可以得到进程挂掉的时间点的一些情况，不过出现这种情况，大概率都是由于内存泄漏导致的。如果近期有新的提交，大概率是新的提交导致的。如果没有，就需要使用专业的检测工具，例如valgrind。

#### 4 总结

本文讲解了进程异常退出的问题定位思路，当然，现在是只有大致的思路，让读者去看哪些内容，如果要定位出最终导致出现问题的代码行，就需要更加专业的工具，而且，不同的语言，通常也会提供不同的工具帮助定位问题。