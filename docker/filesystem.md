## 容器实现过程中的关键技术：文件系统

### 1 镜像和容器

镜像和容器的关系跟程序和进程的关系很类似，程序是静态的，程序运行起来就是进程，同样的，镜像是静态的，镜像运行起来就是容器。在实现上，容器就是在镜像之上加了一个可写层：所有的写操作都在该层完成。这就解释了为什么容器重启后数据就丢失：因为每次重启都会在原来的镜像上重新添加可写层。

为了实现容器的读写层，用到了写时复制技术：当需要写一个文件时，才将文件从镜像中读取，放到可写层，再对文件进行写操作。

对文件的操作通常有4种，因此，容器的可写层通常会有相应的处理：

* 创建文件：直接在可写层创建该文件
* 删除文件：并不真的删除只读层的文件，只在可写层将文件标记为删除
* 修改文件：从只读层读取文件，放到可写层，在可写层进行修改
* 读取文件：读取只读层的文件

### 2 文件系统

AUFS和OverlayFS都是文件级别的overlay文件系统，它们的使用方式跟镜像和容器很类似。AUFS和OverlayFS的差别在于：AUFS分为多层，通常是镜像的每一层对应文件系统的一层；而OverlayFS是两层，使用时下层就是镜像层，上层就是容器层。因此，OverlayFS的性能相对于AUFS更高，而且，OverlayFS已经被合并到Linux主线，而AUFS则需要额外安装。

overlay(通用文件系统，EXT4、XFS)：aufs、overlayfs，每一层都是文件的diff
snapshot(Volumes Formtted)：devicemapper、btrfs、zfs，在块级别处理文件diff